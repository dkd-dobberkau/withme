<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TYPO3 with me — Live Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --t3-orange: #FF8700;
    --t3-orange-light: #FFAA33;
    --t3-orange-glow: rgba(255, 135, 0, 0.4);
    --t3-dark: #1A1A2E;
    --t3-darker: #0F0F1A;
    --t3-surface: #222240;
    --t3-text: #E8E8F0;
    --t3-text-dim: #8888AA;
    --t3-accent: #4ECDC4;
    --t3-pulse: #FF4444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Source Sans 3', sans-serif;
    background: var(--t3-darker);
    color: var(--t3-text);
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  /* Header */
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 28px;
    background: linear-gradient(180deg, rgba(15,15,26,0.95) 0%, rgba(15,15,26,0.7) 80%, transparent 100%);
    backdrop-filter: blur(12px);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .logo-icon {
    width: 42px;
    height: 42px;
    background: var(--t3-orange);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 15px;
    color: #fff;
    box-shadow: 0 0 20px var(--t3-orange-glow);
    letter-spacing: -0.5px;
  }

  .logo-text {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .logo-text span { color: var(--t3-orange); }

  .header-stats {
    display: flex;
    gap: 32px;
    align-items: center;
  }

  .stat { text-align: center; }

  .stat-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 24px;
    font-weight: 700;
    color: var(--t3-orange);
    line-height: 1;
  }

  .stat-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--t3-text-dim);
    margin-top: 4px;
  }

  .live-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 68, 68, 0.15);
    border: 1px solid rgba(255, 68, 68, 0.3);
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: var(--t3-pulse);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .live-badge.connected { color: var(--t3-accent); background: rgba(78,205,196,0.15); border-color: rgba(78,205,196,0.3); }
  .live-badge.connected .live-dot { background: var(--t3-accent); }

  .live-dot {
    width: 8px;
    height: 8px;
    background: var(--t3-pulse);
    border-radius: 50%;
    animation: livePulse 1.5s ease-in-out infinite;
  }

  @keyframes livePulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
  }

  /* Map Container */
  .map-container {
    width: 100vw;
    height: 100vh;
    position: relative;
    overflow: hidden;
    background: var(--t3-darker);
  }

  #mapCanvas {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
  }

  /* Installation Ping */
  .ping {
    position: absolute;
    pointer-events: none;
    z-index: 10;
  }

  .ping-dot {
    width: 8px;
    height: 8px;
    background: var(--t3-orange);
    border-radius: 50%;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 12px var(--t3-orange-glow);
    z-index: 2;
  }

  .ping-ring {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    border: 2px solid var(--t3-orange);
    border-radius: 50%;
    animation: pingExpand 2s ease-out forwards;
    opacity: 0;
  }

  .ping-ring:nth-child(2) { animation-delay: 0.3s; }
  .ping-ring:nth-child(3) { animation-delay: 0.6s; }

  @keyframes pingExpand {
    0% { width: 8px; height: 8px; opacity: 0.8; }
    100% { width: 80px; height: 80px; opacity: 0; }
  }

  /* Toast Notification */
  .toast-container {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 200;
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
  }

  .toast {
    background: var(--t3-surface);
    border: 1px solid rgba(255, 135, 0, 0.25);
    border-radius: 14px;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: toastIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards,
               toastOut 0.4s ease-in 4s forwards;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,135,0,0.1);
    white-space: nowrap;
    backdrop-filter: blur(20px);
  }

  @keyframes toastIn {
    from { opacity: 0; transform: translateY(20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  @keyframes toastOut {
    from { opacity: 1; transform: translateY(0) scale(1); }
    to { opacity: 0; transform: translateY(-10px) scale(0.95); }
  }

  .toast-icon {
    width: 32px;
    height: 32px;
    background: var(--t3-orange);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .toast-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .toast-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--t3-text);
  }

  .toast-detail {
    font-size: 12px;
    color: var(--t3-text-dim);
    font-family: 'JetBrains Mono', monospace;
  }

  .toast-version {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--t3-accent);
    background: rgba(78, 205, 196, 0.1);
    padding: 2px 8px;
    border-radius: 6px;
    margin-left: 8px;
    flex-shrink: 0;
  }

  /* Activity Feed */
  .feed {
    position: fixed;
    right: 20px;
    top: 90px;
    bottom: 100px;
    width: 320px;
    z-index: 50;
    display: flex;
    flex-direction: column;
    gap: 6px;
    overflow: hidden;
    mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 85%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 85%, transparent 100%);
  }

  .feed-item {
    background: rgba(34, 34, 64, 0.7);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 135, 0, 0.08);
    border-radius: 10px;
    padding: 10px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: feedSlide 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    font-size: 13px;
    flex-shrink: 0;
  }

  @keyframes feedSlide {
    from { opacity: 0; transform: translateX(30px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .feed-dot {
    width: 6px;
    height: 6px;
    background: var(--t3-orange);
    border-radius: 50%;
    flex-shrink: 0;
  }

  .feed-city {
    font-weight: 600;
    flex: 1;
  }

  .feed-time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--t3-text-dim);
  }

  .feed-ver {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--t3-accent);
    background: rgba(78, 205, 196, 0.08);
    padding: 2px 6px;
    border-radius: 4px;
  }

  /* Bottom Bar */
  .bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    padding: 16px 28px;
    background: linear-gradient(0deg, rgba(15,15,26,0.95) 0%, rgba(15,15,26,0.7) 80%, transparent 100%);
    backdrop-filter: blur(12px);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .version-chart {
    display: flex;
    align-items: flex-end;
    gap: 6px;
    height: 40px;
  }

  .version-bar-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .version-bar {
    width: 28px;
    border-radius: 4px 4px 0 0;
    background: var(--t3-orange);
    transition: height 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .version-bar.v13 { opacity: 1; }
  .version-bar.v12 { opacity: 0.6; }
  .version-bar.v11 { opacity: 0.35; }

  .version-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--t3-text-dim);
  }

  .region-stats {
    display: flex;
    gap: 24px;
  }

  .region { text-align: center; }

  .region-name {
    font-size: 11px;
    color: var(--t3-text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .region-count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 700;
    color: var(--t3-text);
  }

  .cta-button {
    background: var(--t3-orange);
    color: #fff;
    border: none;
    padding: 12px 28px;
    border-radius: 10px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.3px;
    box-shadow: 0 4px 20px var(--t3-orange-glow);
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }

  .cta-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 28px rgba(255, 135, 0, 0.5);
  }

  /* Existing installations (persistent dots) */
  .existing-dot {
    position: absolute;
    width: 4px;
    height: 4px;
    background: var(--t3-orange);
    border-radius: 50%;
    opacity: 0.25;
    pointer-events: none;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .feed { display: none; }
    .header-stats { gap: 16px; }
    .stat-value { font-size: 18px; }
    .region-stats { gap: 12px; }
    .header { padding: 12px 16px; }
    .bottom-bar { padding: 12px 16px; }
  }
</style>
</head>
<body>

<header class="header">
  <div class="logo">
    <div class="logo-icon">T3</div>
    <div class="logo-text"><span>TYPO3</span> with me</div>
  </div>
  <div class="header-stats">
    <div class="stat">
      <div class="stat-value" id="totalInstalls">0</div>
      <div class="stat-label">Total installations</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="todayCount">0</div>
      <div class="stat-label">Today</div>
    </div>
    <div class="live-badge connected" id="liveBadge">
      <div class="live-dot"></div>
      <span id="liveText">Live</span>
    </div>
  </div>
</header>

<div class="map-container" id="mapContainer">
  <canvas id="mapCanvas"></canvas>
  <div id="pingsLayer"></div>
  <div id="existingDots"></div>
</div>

<div class="feed" id="activityFeed"></div>
<div class="toast-container" id="toastContainer"></div>

<div class="bottom-bar">
  <div class="version-chart" id="versionChart"></div>

  <div class="region-stats">
    <div class="region">
      <div class="region-count" id="regionEU">0</div>
      <div class="region-name">Europe</div>
    </div>
    <div class="region">
      <div class="region-count" id="regionNA">0</div>
      <div class="region-name">Americas</div>
    </div>
    <div class="region">
      <div class="region-count" id="regionAP">0</div>
      <div class="region-name">Asia-Pacific</div>
    </div>
    <div class="region">
      <div class="region-count" id="regionOT">0</div>
      <div class="region-name">Other</div>
    </div>
  </div>

  <a class="cta-button" href="https://get.typo3.org" target="_blank" rel="noopener">
    Install TYPO3 Now
  </a>
</div>

<script>
const API = 'https://api.t3-with.me';

// --- Dot-Matrix World Map ---

// Map projection padding (percentage of viewport)
const MAP_PAD = { left: 0.03, right: 0.03, top: 0.10, bottom: 0.08 };

// Decode TopoJSON topology into arrays of polygon rings (each ring = array of [lng, lat])
function decodeTopology(topo) {
  const tf = topo.transform;
  const decodedArcs = topo.arcs.map(arc => {
    let x = 0, y = 0;
    return arc.map(([dx, dy]) => {
      x += dx; y += dy;
      return [x * tf.scale[0] + tf.translate[0], y * tf.scale[1] + tf.translate[1]];
    });
  });

  function getArc(idx) {
    return idx >= 0 ? decodedArcs[idx] : decodedArcs[~idx].slice().reverse();
  }

  function decodeRing(arcIndices) {
    let coords = [];
    for (const idx of arcIndices) {
      const arc = getArc(idx);
      coords.push(...(coords.length ? arc.slice(1) : arc));
    }
    return coords;
  }

  const polygons = [];
  for (const geom of topo.objects.land.geometries) {
    if (geom.type === 'Polygon') {
      polygons.push(geom.arcs.map(decodeRing));
    } else if (geom.type === 'MultiPolygon') {
      for (const poly of geom.arcs) {
        polygons.push(poly.map(decodeRing));
      }
    }
  }
  return polygons;
}

// Convert geo coordinates to canvas pixel coordinates
function geoToCanvas(lat, lng, w, h) {
  const x = MAP_PAD.left * w + ((lng + 180) / 360) * w * (1 - MAP_PAD.left - MAP_PAD.right);
  const y = MAP_PAD.top * h + ((90 - lat) / 180) * h * (1 - MAP_PAD.top - MAP_PAD.bottom);
  return { x, y };
}

// Convert lat/lng to map x/y percentages (for ping overlay positioning)
function geoToMap(lat, lng) {
  if (lat == null || lng == null) return null;
  const padL = MAP_PAD.left * 100, padR = MAP_PAD.right * 100;
  const padT = MAP_PAD.top * 100, padB = MAP_PAD.bottom * 100;
  return {
    x: Math.max(1, Math.min(99, padL + (lng + 180) / 360 * (100 - padL - padR))),
    y: Math.max(1, Math.min(99, padT + (90 - lat) / 180 * (100 - padT - padB)))
  };
}

// Build the dot-matrix from land polygons
function buildDotMatrix(polygons, w, h, spacing) {
  // Draw filled land polygons on an offscreen canvas
  const off = document.createElement('canvas');
  off.width = w;
  off.height = h;
  const offCtx = off.getContext('2d');
  offCtx.fillStyle = '#fff';

  for (const poly of polygons) {
    offCtx.beginPath();
    for (const ring of poly) {
      for (let i = 0; i < ring.length; i++) {
        const [lng, lat] = ring[i];
        const { x, y } = geoToCanvas(lat, lng, w, h);
        // Skip antimeridian-crossing edges (longitude jump > 90°)
        if (i === 0 || Math.abs(lng - ring[i - 1][0]) > 90) {
          offCtx.moveTo(x, y);
        } else {
          offCtx.lineTo(x, y);
        }
      }
      offCtx.closePath();
    }
    offCtx.fill('evenodd');
  }

  // Sample grid points that fall on land
  const imageData = offCtx.getImageData(0, 0, w, h);
  const data = imageData.data;
  const dots = [];

  for (let gy = spacing / 2; gy < h; gy += spacing) {
    for (let gx = spacing / 2; gx < w; gx += spacing) {
      const px = Math.round(gx);
      const py = Math.round(gy);
      if (px >= w || py >= h) continue;
      const idx = (py * w + px) * 4;
      if (data[idx] > 128) {
        dots.push({
          x: gx,
          y: gy,
          phase: Math.random() * Math.PI * 2,
          baseOpacity: 0.35 + Math.random() * 0.2
        });
      }
    }
  }

  return dots;
}

const EUROPE_CENTER = { lat: 50, lng: 10 };

// Initialize the dot-matrix map
let mapDots = [];
let mapPolygons = null;
let mapAnimId = null;

async function initDotMatrix() {
  const canvas = document.getElementById('mapCanvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;

  try {
    const res = await fetch('land-110m.json');
    const topo = await res.json();
    mapPolygons = decodeTopology(topo);
  } catch (e) {
    console.error('Failed to load map data:', e);
    return;
  }

  function rebuild() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    const spacing = Math.max(3, Math.min(5, Math.round(w / 450)));
    mapDots = buildDotMatrix(mapPolygons, w, h, spacing);
  }

  rebuild();

  // Shimmer animation loop
  let lastFrame = 0;
  function animate(time) {
    mapAnimId = requestAnimationFrame(animate);

    // Cap at ~18fps for efficiency
    if (time - lastFrame < 55) return;
    lastFrame = time;

    const w = canvas.width / dpr;
    const h = canvas.height / dpr;

    ctx.clearRect(0, 0, w, h);

    // Europe glow
    const euroPos = geoToCanvas(EUROPE_CENTER.lat, EUROPE_CENTER.lng, w, h);
    const glowRadius = w * 0.18;
    const grad = ctx.createRadialGradient(euroPos.x, euroPos.y, 0, euroPos.x, euroPos.y, glowRadius);
    grad.addColorStop(0, 'rgba(255, 135, 0, 0.07)');
    grad.addColorStop(1, 'rgba(255, 135, 0, 0)');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, w, h);

    // Draw dot matrix with shimmer
    const t = time * 0.001;
    const dotRadius = Math.max(1, w / 1400);

    for (let i = 0; i < mapDots.length; i++) {
      const dot = mapDots[i];
      const shimmer = dot.baseOpacity + 0.08 * Math.sin(t * 0.7 + dot.phase);
      ctx.fillStyle = `rgba(58, 58, 96, ${shimmer})`;
      ctx.beginPath();
      ctx.arc(dot.x, dot.y, dotRadius, 0, 6.283);
      ctx.fill();
    }
  }

  requestAnimationFrame(animate);

  // Debounced resize
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(rebuild, 200);
  });
}

// Start the map
initDotMatrix();

// --- Dashboard Logic (unchanged) ---

// Country code to region mapping
const EUROPE = new Set(['AL','AD','AT','BY','BE','BA','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IS','IE','IT','XK','LV','LI','LT','LU','MT','MD','MC','ME','NL','MK','NO','PL','PT','RO','RU','SM','RS','SK','SI','ES','SE','CH','TR','UA','GB','VA']);
const AMERICAS = new Set(['US','CA','MX','BR','AR','CL','CO','PE','VE','EC','BO','PY','UY','GY','SR','PA','CR','NI','HN','SV','GT','BZ','CU','JM','HT','DO','TT','BB','BS','PR']);
const APAC = new Set(['CN','JP','KR','IN','AU','NZ','SG','TH','VN','PH','MY','ID','TW','HK','MO','BD','PK','LK','MM','KH','LA','MN','NP','FJ','PG']);

function countryToRegion(cc) {
  if (!cc) return 'OT';
  const c = cc.toUpperCase();
  if (EUROPE.has(c)) return 'EU';
  if (AMERICAS.has(c)) return 'NA';
  if (APAC.has(c)) return 'AP';
  return 'OT';
}

// State
let totalInstalls = 0;
let todayCount = 0;
let regionCounts = { EU: 0, NA: 0, AP: 0, OT: 0 };
let versionCounts = {};
let knownEventIds = new Set();
let initialized = false;

function updateHeaderStats() {
  document.getElementById('totalInstalls').textContent = totalInstalls.toLocaleString();
  document.getElementById('todayCount').textContent = todayCount.toLocaleString();
}

function updateRegionStats() {
  document.getElementById('regionEU').textContent = regionCounts.EU.toLocaleString();
  document.getElementById('regionNA').textContent = regionCounts.NA.toLocaleString();
  document.getElementById('regionAP').textContent = regionCounts.AP.toLocaleString();
  document.getElementById('regionOT').textContent = regionCounts.OT.toLocaleString();
}

function updateVersionChart() {
  const chart = document.getElementById('versionChart');
  const majors = {};
  for (const [ver, count] of Object.entries(versionCounts)) {
    const major = ver.split('.')[0];
    majors[major] = (majors[major] || 0) + count;
  }
  const sorted = Object.keys(majors).sort((a, b) => Number(a) - Number(b));
  const maxCount = Math.max(...Object.values(majors), 1);
  chart.innerHTML = '';
  sorted.forEach(major => {
    const wrap = document.createElement('div');
    wrap.className = 'version-bar-wrap';
    const bar = document.createElement('div');
    bar.className = 'version-bar';
    bar.style.height = Math.max(4, (majors[major] / maxCount) * 35) + 'px';
    const newest = sorted[sorted.length - 1];
    if (major === newest) bar.style.opacity = '1';
    else if (major === String(Number(newest) - 1)) bar.style.opacity = '0.6';
    else bar.style.opacity = '0.35';
    const label = document.createElement('span');
    label.className = 'version-label';
    label.textContent = 'v' + major;
    wrap.appendChild(bar);
    wrap.appendChild(label);
    chart.appendChild(wrap);
  });
}

function createPing(pos) {
  const container = document.getElementById('pingsLayer');
  const ping = document.createElement('div');
  ping.className = 'ping';
  ping.style.left = pos.x + '%';
  ping.style.top = pos.y + '%';
  ping.innerHTML = '<div class="ping-ring"></div><div class="ping-ring"></div><div class="ping-ring"></div><div class="ping-dot"></div>';
  container.appendChild(ping);
  setTimeout(() => ping.remove(), 3000);
}

function showToast(ev) {
  const container = document.getElementById('toastContainer');
  while (container.children.length >= 2) container.firstChild.remove();
  const city = ev.city || 'Unknown';
  const country = ev.country || '';
  const version = (ev.typo3_version || '').split('.').slice(0, 2).join('.');
  const eventType = ev.event_type || 'install';
  const label = eventType === 'update' ? 'Update' : 'New Installation';
  const icon = eventType === 'update' ? '\u2B06\uFE0F' : '\uD83D\uDE80';
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerHTML = `<div class="toast-icon">${icon}</div><div class="toast-content"><div class="toast-title">${label} in ${city}</div><div class="toast-detail">${country} \u00B7 just now</div></div><div class="toast-version">v${version}</div>`;
  container.appendChild(toast);
  setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
}

function addFeedItem(ev, timeStr) {
  const feed = document.getElementById('activityFeed');
  const item = document.createElement('div');
  item.className = 'feed-item';
  const city = ev.city || 'Unknown';
  const country = ev.country || '';
  const version = (ev.typo3_version || '').split('.').slice(0, 2).join('.');
  if (!timeStr) timeStr = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  item.innerHTML = `<div class="feed-dot"></div><div class="feed-city">${city}${country ? ', ' + country : ''}</div><div class="feed-ver">v${version}</div><div class="feed-time">${timeStr}</div>`;
  feed.insertBefore(item, feed.firstChild);
  while (feed.children.length > 30) feed.lastChild.remove();
}

function placeExistingDot(lat, lng) {
  const pos = geoToMap(parseFloat(lat), parseFloat(lng));
  if (!pos) return;
  const container = document.getElementById('existingDots');
  const dot = document.createElement('div');
  dot.className = 'existing-dot';
  dot.style.left = (pos.x + (Math.random() - 0.5) * 2) + '%';
  dot.style.top = (pos.y + (Math.random() - 0.5) * 2) + '%';
  dot.style.opacity = 0.1 + Math.random() * 0.2;
  container.appendChild(dot);
}

// Handle a newly detected event (animate ping + toast)
function handleNewEvent(ev) {
  const pos = geoToMap(parseFloat(ev.latitude), parseFloat(ev.longitude));
  if (pos) {
    createPing(pos);
    placeExistingDot(ev.latitude, ev.longitude);
  }
  showToast(ev);
  addFeedItem(ev);
}

// Fetch stats and detect new events via polling
async function poll() {
  try {
    const res = await fetch(API + '/v1/stats');
    const data = await res.json();

    totalInstalls = data.total_installs || 0;
    todayCount = data.today || 0;
    updateHeaderStats();

    versionCounts = data.versions || {};
    updateVersionChart();

    regionCounts = { EU: 0, NA: 0, AP: 0, OT: 0 };
    for (const [cc, count] of Object.entries(data.countries || {})) {
      regionCounts[countryToRegion(cc)] += count;
    }
    updateRegionStats();

    const recent = data.recent || [];

    if (!initialized) {
      // First load: seed feed and dots without animations
      const reversed = recent.slice().reverse();
      for (const ev of reversed) {
        knownEventIds.add(ev.id);
        const time = new Date(ev.created_at + 'Z');
        const timeStr = time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        addFeedItem(ev, timeStr);
        placeExistingDot(ev.latitude, ev.longitude);
      }
      initialized = true;
    } else {
      // Subsequent polls: detect and animate new events
      for (const ev of recent) {
        if (!knownEventIds.has(ev.id)) {
          knownEventIds.add(ev.id);
          handleNewEvent(ev);
        }
      }
    }
  } catch (e) {
    console.error('Poll failed:', e);
  }
}

// Initialize and start polling every 10 seconds
poll();
setInterval(poll, 10000);
</script>
</body>
</html>
